name: E2E spacectl

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

jobs:
  # Test that install() finds and uses an existing binary on PATH
  existing-binary:
    name: Existing binary
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Verify NSC_POWERTOYS_DIR is set
        run: |
          if [ -z "$NSC_POWERTOYS_DIR" ]; then
            echo "::error::NSC_POWERTOYS_DIR is not set - this test must run on a Namespace runner"
            exit 1
          fi
          echo "NSC_POWERTOYS_DIR=$NSC_POWERTOYS_DIR"
          ls -la "$NSC_POWERTOYS_DIR"

      - name: Remove spacectl from PATH if present
        run: |
          if command -v spacectl &> /dev/null; then
            SPACECTL_PATH=$(which spacectl)
            echo "Removing spacectl from PATH: $SPACECTL_PATH"
            sudo rm -f "$SPACECTL_PATH"
          fi
          if command -v spacectl &> /dev/null; then
            echo "::error::Failed to remove spacectl from PATH"
            exit 1
          fi

      - name: Test install (use existing from powertoys)
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const powertoysDir = process.env.NSC_POWERTOYS_DIR;
            const result = await install();
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            if (!result.version) {
              throw new Error('Expected version to be set');
            }
            if (result.downloaded !== false) {
              throw new Error('Expected downloaded to be false for existing binary');
            }
            if (!result.binPath.startsWith(powertoysDir)) {
              throw new Error('Expected binPath to be in NSC_POWERTOYS_DIR, got ' + result.binPath);
            }
            const execResult = await exec(['version']);
            console.log('exec output:', execResult.stdout);
          "

  # Test installing a specific version
  specific-version:
    name: Specific version
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test install (specific version)
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const result = await install({ version: '0.5.0', useSystemBinary: false });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            if (result.version !== '0.5.0') {
              throw new Error('Expected version 0.5.0, got ' + result.version);
            }
            if (result.downloaded !== true) {
              throw new Error('Expected downloaded to be true for fresh install');
            }
            const execResult = await exec(['version'], { binPath: result.binPath });
            console.log('exec output:', execResult.stdout);
          "

  # Test installing latest version
  latest-version:
    name: Latest version (force download)
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Get latest version from GitHub API
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(gh api repos/namespacelabs/spacectl/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST"

      - name: Test install (latest)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXPECTED_VERSION: ${{ steps.latest.outputs.version }}
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const expected = process.env.EXPECTED_VERSION;
            const result = await install({ version: 'latest', useSystemBinary: false });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            console.log('expected:', expected);
            if (result.version !== expected) {
              throw new Error('Expected version ' + expected + ', got ' + result.version);
            }
            if (result.downloaded !== true) {
              throw new Error('Expected downloaded to be true for fresh install');
            }
            const execResult = await exec(['version'], { binPath: result.binPath });
            console.log('exec output:', execResult.stdout);
          "
