name: E2E spacectl

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]
  workflow_dispatch:

jobs:
  # Test systemBinary: "require" uses existing binary
  require-system-binary:
    name: Require system binary (${{ matrix.runner }})
    strategy:
      matrix:
        runner:
          - nscloud-ubuntu-22.04-amd64-4x8-with-cache
          - nscloud-macos-arm64-with-cache
    runs-on:
      - ${{ matrix.runner }}
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Verify NSC_POWERTOYS_DIR is set
        run: |
          if [ -z "$NSC_POWERTOYS_DIR" ]; then
            echo "::error::NSC_POWERTOYS_DIR is not set - this test must run on a Namespace runner"
            exit 1
          fi

      - name: Test install (require system binary)
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const powertoysDir = process.env.NSC_POWERTOYS_DIR;
            const result = await install({ systemBinary: 'require' });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            if (result.downloaded !== false) {
              throw new Error('Expected downloaded to be false');
            }
            if (!result.binPath.startsWith(powertoysDir)) {
              throw new Error('Expected binPath to be in NSC_POWERTOYS_DIR, got ' + result.binPath);
            }
            const execResult = await exec(['version']);
            console.log('exec output:', execResult.stdout);
          "

  # Test systemBinary: "require" errors when no binary exists
  require-system-binary-missing:
    name: Require system binary (missing)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test install (require system binary fails)
        run: |
          node --input-type=module -e "
            import { install, SpacectlInstallError } from './dist/spacectl.mjs';
            try {
              await install({ systemBinary: 'require' });
              throw new Error('Expected install to throw');
            } catch (error) {
              if (!(error instanceof SpacectlInstallError)) {
                throw new Error('Expected SpacectlInstallError, got ' + error.constructor.name);
              }
              if (error.code !== 'SYSTEM_BINARY_NOT_FOUND') {
                throw new Error('Expected SYSTEM_BINARY_NOT_FOUND, got ' + error.code);
              }
              console.log('Correctly threw SYSTEM_BINARY_NOT_FOUND');
            }
          "

  # Test systemBinary: "ignore" downloads even when system binary exists
  ignore-system-binary:
    name: Ignore system binary
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test install (ignore system binary, downloads instead)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const powertoysDir = process.env.NSC_POWERTOYS_DIR;
            const result = await install({ systemBinary: 'ignore' });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            if (powertoysDir && result.binPath.startsWith(powertoysDir)) {
              throw new Error('Expected binPath to NOT be in NSC_POWERTOYS_DIR');
            }
            const execResult = await exec(['version'], { binPath: result.binPath });
            console.log('exec output:', execResult.stdout);
          "

  # Test installing a specific version (skips system binary with default "prefer")
  specific-version:
    name: Specific version
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Test install (specific version)
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const result = await install({ version: '0.5.0' });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            if (result.version !== '0.5.0') {
              throw new Error('Expected version 0.5.0, got ' + result.version);
            }
            if (result.downloaded !== true) {
              throw new Error('Expected downloaded to be true for fresh install');
            }
            const execResult = await exec(['version'], { binPath: result.binPath });
            console.log('exec output:', execResult.stdout);
          "

  # Test installing latest version
  latest-version:
    name: Latest version
    runs-on:
      - nscloud-ubuntu-22.04-amd64-4x8-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-actions-toolkit

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: lts/*

      - name: Cache pnpm
        uses: namespacelabs/nscloud-cache-action@v1
        with:
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Get latest version from GitHub API
        id: latest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST=$(gh api repos/namespacelabs/spacectl/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest version: $LATEST"

      - name: Test install (latest)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXPECTED_VERSION: ${{ steps.latest.outputs.version }}
        run: |
          node --input-type=module -e "
            import { install, exec } from './dist/spacectl.mjs';
            const expected = process.env.EXPECTED_VERSION;
            const result = await install({ version: 'latest' });
            console.log('binPath:', result.binPath);
            console.log('version:', result.version);
            console.log('downloaded:', result.downloaded);
            console.log('expected:', expected);
            if (result.version !== expected) {
              throw new Error('Expected version ' + expected + ', got ' + result.version);
            }
            if (result.downloaded !== true) {
              throw new Error('Expected downloaded to be true for fresh install');
            }
            const execResult = await exec(['version'], { binPath: result.binPath });
            console.log('exec output:', execResult.stdout);
          "

  e2e-ok:
    name: E2E
    if: always()
    needs:
      - require-system-binary
      - require-system-binary-missing
      - ignore-system-binary
      - specific-version
      - latest-version
    runs-on: ubuntu-latest
    steps:
      - name: Check result
        run: |
          if [ "${{ contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled') }}" = "true" ]; then
            echo "::error::One or more E2E jobs failed or were cancelled"
            exit 1
          fi
